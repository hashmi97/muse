generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  bride
  groom
  other
}

enum MemberRole {
  bride
  groom
  viewer
  editor
}

enum MemberStatus {
  invited
  active
  left
}

enum LanguagePref {
  en
  ar
  hybrid
}

enum ReactionType {
  heart
}

enum HoneymoonItemType {
  flight
  hotel
  activity
  other
}

enum TaskStatus {
  todo
  in_progress
  done
}

enum CommentTargetType {
  event
  mood_board_item
  budget_line_item
  honeymoon_item
  task
}

model users {
  id             Int        @id @default(autoincrement())
  email          String     @unique
  password_hash  String
  full_name      String
  role           UserRole
  avatar_media   media_files? @relation("UserAvatar", fields: [avatar_media_id], references: [id])
  avatar_media_id Int? @unique
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt
  uploaded_media media_files[] @relation("MediaUploader")
  mood_board_items mood_board_items[] @relation("MoodItemCreator")
  mood_board_reactions mood_board_reactions[]
  budget_line_items budget_line_items[]
  tasks_assigned  tasks[]   @relation("TaskAssignee")
  tasks_created   tasks[]   @relation("TaskCreator")
  comments        comments[]
  activity_logs   activity_log[]
  notifications   notifications[]
  couple_members  couple_members[]
}

model couples {
  id           Int      @id @default(autoincrement())
  name         String
  wedding_date DateTime?
  language_pref LanguagePref
  theme        String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  members      couple_members[]
  events       events[]
  media_files  media_files[]
  tasks        tasks[]
  comments     comments[]
  activity_logs activity_log[]
}

model couple_members {
  id         Int          @id @default(autoincrement())
  couple_id  Int
  user_id    Int
  role       MemberRole
  is_owner   Boolean      @default(false)
  status     MemberStatus @default(invited)
  created_at DateTime     @default(now())

  couple couples @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  user   users   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([couple_id, user_id])
}

model event_types {
  id                       Int      @id @default(autoincrement())
  key                      String   @unique
  name_en                  String
  name_ar                  String?
  default_color_hex        String?
  default_moodboard_enabled Boolean @default(false)

  events events[]
}

model events {
  id            Int        @id @default(autoincrement())
  couple_id     Int
  event_type_id Int
  title         String?
  description   String?
  start_date    DateTime?
  end_date      DateTime?
  is_active     Boolean    @default(true)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt

  couple     couples     @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  event_type event_types @relation(fields: [event_type_id], references: [id])
  mood_board mood_boards?
  event_budget event_budgets?
  honeymoon_plan honeymoon_plans?
  tasks       tasks[]

  @@unique([couple_id, event_type_id])
}

model media_files {
  id            Int       @id @default(autoincrement())
  couple_id     Int
  storage_key   String
  mime_type     String
  size_bytes    Int
  uploaded_by   Int
  created_at    DateTime  @default(now())

  couple couples @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  uploader users @relation("MediaUploader", fields: [uploaded_by], references: [id])
  avatar_of users? @relation("UserAvatar")
  mood_board_items mood_board_items[]
  budget_line_items budget_line_items[]
}

model mood_boards {
  id        Int      @id @default(autoincrement())
  event_id  Int      @unique
  is_enabled Boolean @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  event events @relation(fields: [event_id], references: [id], onDelete: Cascade)
  items mood_board_items[]
}

model mood_board_items {
  id            Int       @id @default(autoincrement())
  mood_board_id Int
  media_id      Int
  caption       String?
  position      Int?
  created_by    Int
  created_at    DateTime  @default(now())

  mood_board mood_boards @relation(fields: [mood_board_id], references: [id], onDelete: Cascade)
  media      media_files @relation(fields: [media_id], references: [id])
  creator    users       @relation("MoodItemCreator", fields: [created_by], references: [id])
  reactions  mood_board_reactions[]
}

model mood_board_reactions {
  id                Int          @id @default(autoincrement())
  mood_board_item_id Int
  user_id           Int
  reaction_type     ReactionType
  created_at        DateTime      @default(now())

  mood_board_item mood_board_items @relation(fields: [mood_board_item_id], references: [id], onDelete: Cascade)
  user            users            @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([mood_board_item_id, user_id, reaction_type])
}

model event_budgets {
  id           Int      @id @default(autoincrement())
  event_id     Int      @unique
  currency_code String
  total_planned Decimal  @default(0) @db.Decimal(12, 2)
  total_spent   Decimal  @default(0) @db.Decimal(12, 2)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  event events @relation(fields: [event_id], references: [id], onDelete: Cascade)
  categories event_budget_categories[]
}

model budget_categories {
  id                 Int     @id @default(autoincrement())
  key                String  @unique
  label              String
  sort_order         Int     @default(0)
  is_default_for_omani Boolean @default(false)

  event_categories event_budget_categories[]
}

model event_budget_categories {
  id               Int      @id @default(autoincrement())
  event_budget_id  Int
  category_id      Int
  planned_amount   Decimal @default(0) @db.Decimal(12, 2)
  spent_amount     Decimal @default(0) @db.Decimal(12, 2)

  event_budget event_budgets     @relation(fields: [event_budget_id], references: [id], onDelete: Cascade)
  category     budget_categories @relation(fields: [category_id], references: [id])
  line_items   budget_line_items[]

  @@unique([event_budget_id, category_id])
}

model budget_line_items {
  id                        Int      @id @default(autoincrement())
  event_budget_category_id  Int
  label                     String
  planned_amount            Decimal? @db.Decimal(12, 2)
  actual_amount             Decimal? @db.Decimal(12, 2)
  notes                     String?
  paid_on                   DateTime?
  receipt_media_id          Int?
  created_by                Int?
  created_at                DateTime @default(now())
  updated_at                DateTime @updatedAt

  category event_budget_categories @relation(fields: [event_budget_category_id], references: [id], onDelete: Cascade)
  receipt  media_files?             @relation(fields: [receipt_media_id], references: [id])
  creator  users?                   @relation(fields: [created_by], references: [id])
}

model honeymoon_plans {
  id             Int      @id @default(autoincrement())
  event_id       Int      @unique
  destination_country String
  destination_city String
  start_date     DateTime?
  end_date       DateTime?
  notes          String?
  total_planned  Decimal @default(0) @db.Decimal(12, 2)
  total_spent    Decimal @default(0) @db.Decimal(12, 2)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  event events @relation(fields: [event_id], references: [id], onDelete: Cascade)
  items honeymoon_items[]
}

model honeymoon_items {
  id                 Int      @id @default(autoincrement())
  honeymoon_plan_id  Int
  type               HoneymoonItemType
  label              String
  start_date         DateTime?
  end_date           DateTime?
  planned_amount     Decimal @default(0) @db.Decimal(12, 2)
  actual_amount      Decimal @default(0) @db.Decimal(12, 2)
  provider_name      String?
  booking_ref        String?
  notes              String?
  created_at         DateTime @default(now())

  honeymoon_plan honeymoon_plans @relation(fields: [honeymoon_plan_id], references: [id], onDelete: Cascade)
}

model tasks {
  id          Int        @id @default(autoincrement())
  couple_id   Int
  event_id    Int?
  title       String
  description String?
  status      TaskStatus @default(todo)
  due_date    DateTime?
  assigned_to Int?
  created_by  Int?
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt

  couple couples @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  event  events? @relation(fields: [event_id], references: [id])
  assignee users? @relation("TaskAssignee", fields: [assigned_to], references: [id])
  creator  users? @relation("TaskCreator", fields: [created_by], references: [id])
}

model comments {
  id          Int               @id @default(autoincrement())
  couple_id   Int
  author_id   Int
  target_type CommentTargetType
  target_id   Int
  body        String
  created_at  DateTime @default(now())

  couple couples @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  author users  @relation(fields: [author_id], references: [id], onDelete: Cascade)

  @@index([target_type, target_id])
}

model activity_log {
  id          Int       @id @default(autoincrement())
  couple_id   Int
  user_id     Int?
  action_type String
  entity_type String
  entity_id   Int
  payload     Json?
  created_at  DateTime  @default(now())

  couple couples @relation(fields: [couple_id], references: [id], onDelete: Cascade)
  user   users?   @relation(fields: [user_id], references: [id])

  @@index([entity_type, entity_id])
}

model notifications {
  id              Int      @id @default(autoincrement())
  user_id         Int
  type            String
  title           String
  body            String
  is_read         Boolean  @default(false)
  link_entity_type String?
  link_entity_id  Int?
  created_at      DateTime @default(now())

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)
}
